# -*- snakemake -*-
import os
from snakemakelib.config import update_sml_config, sml_rules_path, get_sml_config
from snakemakelib.bio.ngs.methylseq.bismark import ref

# Start by including the general bio.ngs snakefile
include: os.path.join(sml_rules_path(), 'bio/ngs', 'settings.rules')

sml_config = get_sml_config()

config_default = {
    'bio.ngs.methylseq.bismark' : BaseConfig({
        #'ref' : sml_config['bio.ngs.settings']['db']['ref'],
        'ref' : ref(),
        'align' : {
            'cmd' : 'bismark',
            'options' : '--bam --bowtie2 --phred33-quals',
        },
        'deduplicate' : {
            'cmd' : 'deduplicate_bismark',
            'options' : '-p',
        },
        'methXtract' : {
            'cmd' : 'bismark_methylation_extractor',
            'options' : "--bedGraph --counts  --gzip -p --no_overlap --report",
        },
        'report' : {
            'cmd' : 'bismark2report',
        },
    },
}
update_sml_config(config_default)

cfg = get_sml_config('bio.ngs.methylseq.bismark')

rule bismark_align:
    """bismark: Run bismark align."""
    params: options = cfg['align']['options'],
            cmd = cfg['align']['cmd'],
            ref = cfg['ref']
    input: "{path}" + os.sep + "{prefix}",\
           "{path}" + os.sep + "{prefix}"
    output: "{path}" + os.sep + "{prefix}_bismark_bt2_pe.bam"
    shell: "{params.cmd} {params.options} {params.ref} -1 {input[0]} -2 {input[1]} -o {wildcards.path}"

# output: 8_140207_AC3NVGACXX_P923_101_1_val_1.fq.gz_bismark_bt2_pe.deduplicated.bam
rule bismark_deduplicate:
    """bismark: Run bismark deduplication."""
    params: options = cfg['deduplicate']['options'],
            cmd = cfg['deduplicate']['cmd'],
    input: "{path}" + os.sep + "{prefix}" + ".bam"
    output: "{path}" + os.sep + "{prefix}.deduplicated.bam"
    shell: "{params.cmd} {params.options} {input}"
    

# output: 8_140207_AC3NVGACXX_P923_101_1_val_1.fq.gz_bismark_bt2_pe.deduplicated.bedGraph
# 8_140207_AC3NVGACXX_P923_101_1_val_1.fq.gz_bismark_bt2_pe.deduplicated.bismark.cov
rule bismark_methXtract:
    """bismark: Run bismark methylation extractor"""
    params: options = cfg['methXtract']['options'],
            cmd = cfg['methXtract']['cmd'],
    input: "{path}" + os.sep + "{prefix}" + ".bam"
    output: "{path}" + os.sep + "{prefix}.bedGraph", "{path}" + os.sep + "{prefix}.cov"
    shell: "{params.cmd} {params.options} {input}"

# input: 8_140207_AC3NVGACXX_P923_101_1_val_1.fq.gz_bismark_bt2_pe.deduplicated.bedGraph
# output: 8_140207_AC3NVGACXX_P923_101_1_val_1.fq.gz_bismark_bt2_pe.deduplicated.M-bias.txt
# rule bismark_report:
#     """bismark: Run bismark report. 

#     This rule currently *requires* that methylation extraction has
#     been run as the input depends on the bedGraph output from
#     bismark_methXtract.
#     """
#     params: options = cfg['report']['options'],
#             cmd = cfg['report']['cmd']
#     input: "{path}" + os.sep + "{prefix}" + ".bedGraph"
#     output: "{path}" + os.sep + "{prefix}.M-bias.txt"
#     shell: "{params.cmd} {params.options} --mbias {input}"

