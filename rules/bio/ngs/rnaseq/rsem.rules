# -*- snakemake -*-
import os
from snakemakelib.config import update_sml_config, get_sml_config
from snakemakelib.bio.ngs.db import index
from snakemakelib.bio.ngs.targets import generic_target_generator

include: '../settings.rules'

ngs_cfg = get_sml_config('bio.ngs.settings')

config_default = { 
    'bio.ngs.rnaseq.rsem' : {
        'annot_gtf' : ngs_cfg['annotation']['transcript_annot_gtf'],
        'threads' : ngs_cfg['threads'],
        'ref' : ngs_cfg['db']['ref'],
        'ref_sfx' : '.transcripts.fa',
        'index' : index,
        'prepare-reference' : {
            'cmd' : 'rsem-prepare-reference',
            'options' : "",
            'reference_name' : "rsem",
        },
        'calculate-expression' : {
            'cmd' : 'rsem-calculate-expression',
            'options' : '',
            'bowtie-options' : "--no-bam-output --bowtie-chunkmbs 512",
        },
    },
}

update_sml_config(config_default)

aligner = get_sml_config('bio.ngs.settings')['aligner']
rsem_cfg = get_sml_config('bio.ngs.rnaseq.rsem')

# Take into account different aligners
align_section = 'bio.ngs.align.' + aligner
align_include = os.path.join('../align', aligner + ".rules")

include: align_include

align_cfg = get_sml_config(align_section)

# See https://groups.google.com/forum/#!topic/rna-star/tvajn49WTYk for
# setting up RSEM with STAR alignments
rule rsem_prepare_reference:
    """Prepare RSEM transcripts file"""
    params: cmd = rsem_cfg['prepare-reference']['cmd'],
            options = " ".join([rsem_cfg['prepare-reference']['options'],
            "--gtf {annot}".format(annot=rsem_cfg['annot_gtf']) if rsem_cfg['annot_gtf'] else ""]),
            ref = rsem_cfg['ref'],
            index = rsem_cfg['index', 'rsem']
    input: ref = rsem_cfg['ref']
    output: rsem_cfg['index', 'rsem'] + rsem_cfg['ref_sfx']
    shell: "{params.cmd} {params.options} {input.ref} {params.index}"

rule rsem_calculate_expression_bowtie:
    """Run RSEM on bowtie output. Requires a fifo hack to work: see
    http://atgcio.blogspot.se/2013/08/fifos-and-mapping-with-bowtie-using.html
    """
    params: cmd = rsem_cfg['calculate-expression']['cmd'],
            options = rsem_cfg['calculate-expression']['options'],
            index = rsem_cfg['index', 'rsem'] + rsem_cfg['ref_sfx']
    input: read1 = "{prefix}" + ngs_cfg['read1_label'] + ngs_cfg['fastq_suffix'],\ 
           read2 = "{prefix}" + ngs_cfg['read2_label'] + ngs_cfg['fastq_suffix'],\
           index = rsem_cfg['index', 'rsem'] + rsem_cfg['ref_sfx'],
           bowtie_index = expand(rsem_cfg['index', 'rsem'] + "{ext}", ext=align_cfg.get('build', {}).get('ext_v1', ""))
    output: "{prefix}.rsem"
    threads: ngs_cfg["threads"]
    run: 
      fifo1 = input.read1 + ".read1.fifo"
      fifo2 = input.read2 + ".read2.fifo"
      shell("rm -f " + fifo1)
      shell("rm -f " + fifo2)
      shell("mkfifo " + fifo1)
      shell("mkfifo " + fifo2)
      shell("zcat " + input.read1 + " > " + fifo1 + " &")
      shell("zcat " + input.read2 + " > " + fifo2 + " &")
      shell("{cmd} {options} -p {threads} --paired-end {fifo1} {fifo2} {index} {sample} &> {log}.tmp && mv {log}.tmp {log}.rsem".format(cmd=params.cmd, options=params.options, threads=threads, fifo1=fifo1, fifo2=fifo2, index=rsem_cfg['index', 'rsem'], sample=wildcards.prefix, log=wildcards.prefix))
      shell("rm -f " + fifo1)
      shell("rm -f " + fifo2)

rule rsem_calculate_expression:
    """Calculate RSEM expression from bam"""
    params: cmd = rsem_cfg['calculate-expression']['cmd'],
            options = " ".join(["--bam",  "--paired-end",
            rsem_cfg['calculate-expression']['options']]),
            index = rsem_cfg['index', 'rsem']
    input: index = rsem_cfg['index', 'rsem'] + rsem_cfg['ref_sfx'],
           bam = "{prefix}.bam"
    output: isoforms = "{prefix}.isoforms.results", genes = "{prefix}.genes.results"
    threads: ngs_cfg["threads"]
    shell: "{params.cmd} {params.options} -p {threads} {input.bam} {params.index} {wildcards.prefix}"


def rsem_find_result_files_fn(wildcards):
    ngs_cfg = get_sml_config('bio.ngs.settings')
    fmt = ngs_cfg['sample_pfx_fmt'] + ".".join(["", wildcards.label,  wildcards.type]) + '.results'
    sources = generic_target_generator(fmt=fmt, rg=ReadGroup(ngs_cfg['run_id_pfx_re'] + ngs_cfg['read1_label'] + ngs_cfg['fastq_suffix']), cfg=ngs_cfg, path=wildcards.path, prepend_path=False)
    return sources

rule rsem_summarize_expression_data:
    """Summarize expression results"""
    input: rsem_find_result_files_fn
    output: os.path.join("{path}", "rsem.{label}.{type}.results")
    run:
        print ("rsem_summarize_expression_data")
        #print (len(input))

    
