# -*- snakemake -*-
import os
from snakemakelib.config import update_sml_config, sml_rules_path, get_sml_config

# Start by including the general snakefile
include: os.path.join(sml_rules_path(), 'bio/ngs', 'settings.rules')

sml_config = get_sml_config()

config_default = { 
    'bio.ngs.tools.samtools' : {
        'ref' : sml_config['bio.ngs.settings']['db']['ref'],
        'cmd' : "samtools",
        'threads' : sml_config['bio.ngs.settings']['threads'],
        'options' : "",
    },
}

update_sml_config(config_default)

samtools_config = sml_config['bio.ngs.tools.samtools']

rule samtools_sam2bam:
    """Convert sam file to bam"""
    params: cmd = samtools_config['cmd'],
            options = samtools_config['options']
    input: "{prefix}.sam"
    output: "{prefix}.bam"
    shell: "{params.cmd} view {params.options} -Sb {input} > {output}"

rule samtools_gene_region_from_bam:
    """Extract gene region from bam file"""
    params: cmd = samtools_config['cmd'],
            options = samtools_config['options']
    input: bam = "{prefix}.bam", bed = "{prefix}.region_{region}.{sfx}.bed"
    output: temp("{prefix}.region_{region}.{sfx}.bam")
    shell: "{params.cmd} view {params.options} -b -L {input.bed} {input.bam} > {output}"

ruleorder: samtools_gene_region_from_bam > samtools_sam2bam
