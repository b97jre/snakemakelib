# -*- snakemake -*-
import os
from snakemakelib.config import update_sml_config, sml_rules_path, BaseConfig, get_sml_config

# Start by including the general snakefile
include: os.path.join(sml_rules_path(), 'bio/ngs', 'settings.rules')

sml_config = get_sml_config()

config_default = BaseConfig({ 
    'bio.ngs.align.bwa' : BaseConfig({
        'cmd' : "bwa",
        'ref' : sml_config['bio.ngs.settings']['db']['ref'],
        'threads' : sml_config['bio.ngs.settings']['threads'],
        'options' : "-M",
        'mem' : BaseConfig({
            'options' : "",
        }),
    }),
})

update_sml_config(config_default)

sml_config = get_sml_config()

config_default['bio.ngs.align.bwa']['mem']['options'] = sml_config['bio.ngs.align.bwa']['options']

update_sml_config(config_default)

sml_config = get_sml_config()

bwa_cfg = sml_config['bio.ngs.align.bwa']
ngs_cfg = sml_config['bio.ngs.settings']
samtools_cfg = sml_config['bio.ngs.tools.samtools']

rule bwa_mem:
    """Run bwa mem"""
    params: options = bwa_cfg['mem']['options'],
            cmd = bwa_cfg['cmd'],
            ref = bwa_cfg['ref']
    input: "{prefix}" + ngs_cfg['read1_label'] + ngs_cfg['fastq_suffix'],\
    "{prefix}" + ngs_cfg['read2_label'] + ngs_cfg['fastq_suffix']
    output: "{prefix}.bam"
    threads: bwa_cfg['threads']
    shell: "{params.cmd} mem -t {threads} {params.options} {params.ref} {input} | " + samtools_cfg['cmd'] + " view -Sb - > {output}"
