# -*- snakemake -*-
import os
from snakemakelib.utils import update_config, sml_rules_path
import snakemakelib.variables as VAR

# Start by including the general snakefile
include: os.path.join(sml_rules_path(), 'bio/ngs', 'settings.rules')

BIO_NGS_ALIGN_BWA="bio.ngs.align.bwa"
MEM = "mem"

config_default = { 
    VAR.BIO_NGS_ALIGN_BWA : {
        VAR.CMD : "bwa",
        VAR.REF : config[VAR.BIO_NGS_SETTINGS][VAR.DB][VAR.REF],
        VAR.THREADS : config[VAR.BIO_NGS_SETTINGS][VAR.THREADS],
        VAR.OPTIONS : "-M"
    },
}
config_default[VAR.BIO_NGS_ALIGN_BWA][VAR.MEM] = {'options' : config_default[VAR.BIO_NGS_ALIGN_BWA][VAR.OPTIONS]}

config = update_config(config, config_default)

rule bwa_mem:
    """Run bwa mem"""
    params: options = config[VAR.BIO_NGS_ALIGN_BWA][VAR.MEM][VAR.OPTIONS],
            cmd = config[VAR.BIO_NGS_ALIGN_BWA][VAR.CMD],
            ref = config[VAR.BIO_NGS_ALIGN_BWA][VAR.REF]
    input: "{prefix}" + config[VAR.BIO_NGS_SETTINGS][VAR.READ1_LABEL] + config[VAR.BIO_NGS_SETTINGS][VAR.FASTQ_SUFFIX],\
    "{prefix}" + config[VAR.BIO_NGS_SETTINGS][VAR.READ2_LABEL] + config[VAR.BIO_NGS_SETTINGS][VAR.FASTQ_SUFFIX]
    output: "{prefix}.bam"
    threads: config[VAR.BIO_NGS_ALIGN_BWA][VAR.THREADS]
    shell: "{params.cmd} mem -t {threads} {params.options} {params.ref} {input} | " + config[VAR.BIO_NGS_TOOLS_SAMTOOLS][VAR.CMD] + " view -Sb - > {output}"
