# -*- snakemake -*-
import os
from snakemakelib.utils import update_config, sml_rules_path

# Start by including the general snakefile
include: os.path.join(sml_rules_path(), 'bio/ngs', 'settings.rules')

BIO_NGS_ALIGN_BWA="bio.ngs.align.bwa"
MEM = "mem"

config_default = { 
    BIO_NGS_ALIGN_BWA : {
        CMD : "bwa",
        REF : config[BIO_NGS_SETTINGS][DB][REF],
        THREADS : config[BIO_NGS_SETTINGS][THREADS],
        OPTIONS : "-M"
    },
}
config_default[BIO_NGS_ALIGN_BWA][MEM] = {'options' : config_default[BIO_NGS_ALIGN_BWA][OPTIONS]}

config = update_config(config, config_default)

rule bwa_mem:
    """Run bwa mem"""
    params: options = config[BIO_NGS_ALIGN_BWA][MEM][OPTIONS],
            cmd = config[BIO_NGS_ALIGN_BWA][CMD],
            ref = config[BIO_NGS_ALIGN_BWA][REF]
    input: "{prefix}" + config[BIO_NGS_SETTINGS][READ1_LABEL] + config[BIO_NGS_SETTINGS][FASTQ_SUFFIX],\
    "{prefix}" + config[BIO_NGS_SETTINGS][READ2_LABEL] + config[BIO_NGS_SETTINGS][FASTQ_SUFFIX]
    output: "{prefix}.bam"
    threads: config[BIO_NGS_ALIGN_BWA][THREADS]
    shell: "{params.cmd} mem -t {threads} {params.options} {params.ref} {input} | " + config["bio.ngs.tools.samtools"]["cmd"] + " view -Sb - > {output}"
